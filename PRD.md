# Product Requirements Document (PRD)

Продукт: Heater Sensor Modbus Slave на STM32F401CCU6  
Назначение: предоставление измерений и статусов нагревателя по Modbus; конфигурирование параметров. В типовой системе устройством управляет внешнее ведущее устройство (Modbus Master) из проекта dobord/h-id_heater_control_modbus_master_stm32f401ccu6.

Содержание:
- Пользовательские сценарии
- Функциональные требования
- Нефункциональные требования
- Интерфейсы и протоколы
- Производительность и тайминг
- Качество и надежность
- Безопасность и защита
- Производство и калибровка
- Версионирование и выпуск

## Пользовательские сценарии

- Мастер-устройство по RS‑485 опрашивает Input-регистры для получения температур/статусов.
- Мастер изменяет параметры через Holding (FC=06/16), в т.ч. командует флагами управления.
- Мастер использует «маскированную запись» (вендорская команда на базе FC=16) для атомарного обновления битов в управляющем слове.
- Инженер локально (через Modbus) настраивает адрес/скорость и сохраняет конфигурацию во FLASH.

## Функциональные требования

- FR-1: Измерять температуру(ы) нагревателя.
- FR-2: Предоставлять измерения в регистрах Input (FC=04).
- FR-3: Предоставлять статус/диагностику в Discrete Inputs и Input Registers.
- FR-4: Поддерживать конфигурацию через Holding (FC=03/06/16) и Coils (FC=01/05/15).
- FR-5: Поддержка базовой идентификации устройства (Device Identification, FC=43/14 — рекомендовано для мастера).
- FR-6: Возможность «Save Config to FLASH» командой.
- FR-7: Сброс к заводским настройкам (coil/команда).
- FR-M1: Поддержка вендорской команды «маскированной записи слов» через FC=16 в Short IO Service Area (см. MODBUS-API.md).
- FR-M2: Отражение ключевых флагов управления как битов в одном 16-битном «управляющем слове» для совместимости с мастер-паттернами.

## Нефункциональные требования

- NFR-1: Надежный ответ на корректные запросы с вероятностью ошибки < 1e-6 при нормальных условиях.
- NFR-2: Время ответа T_response ≤ 10 ms при бодрейте ≥ 115200; ≤ 25 ms при 38400; ≤ 50 ms при 9600 (типично, без учета времени линии).
- NFR-3: Идемпотентность операций записи: повтор одного и того же запроса не должен приводить к неконсистентным состояниям.
- NFR-4: Устойчивость к перезапуску/питанию: конфигурация сохраняется и валидируется.
- NFR-5: Поддержка температурной среды −20…+70 °C (уточняется).

## Интерфейсы и протоколы

- Modbus RTU: UART/RS‑485, адрес ведомого настраиваемый (1…247).
- Параметры UART: по умолчанию 9600 8N1; настраиваемые скорость/паритет/стоп-биты.
- Совместимость с мастером: поддержка чтения FC=04, записи FC=06/16, а также вендорского сервиса маскированной записи через FC=16 (см. MODBUS-API.md).
- Лог USB CDC (опционально) для сервисных задач.

## Производительность и тайминг

- Частота выборок: 10–100 Гц (настраиваемо).
- Усреднение: окно N=1..64 выборок.
- Время «заселения» фильтра после изменения N ≤ 1 с при дефолтных настройках.
- Время ответа под опрос мастера: см. NFR-2.

## Качество и надежность

- HW Watchdog (IWDG) активен в релизных сборках.
- Обнаружение ошибок датчиков (обрыв, КЗ, вне диапазона).
- Счетчики ошибок протокола, последняя ошибка — доступны в регистрах.
- Самодиагностика питания (Vcc через Vrefint ADC) — опционально.

## Безопасность и защита

- Защита записи критичных регистров (например, через «unlock key»/магическое значение).
- Rate limiting для частых операций сохранения во FLASH.
- Битовое поле прав (опционально): запрет конфигурации в «production mode».

## Производство и калибровка

- Заводские дефолты: адрес 1, 9600 8N1, период 100 ms, усреднение 8.
- Калибровка: Temperature Offset (0.01 °C шаг), Scale (ppm/LSB опционально).
- Команда «Factory Reset» восстанавливает дефолты.

## Версионирование и выпуск

- Семантическое версионирование FW: MAJOR.MINOR.PATCH.
- Регистры версии и строка Device ID (Vendor, Product Code, Revision).
- Changelog в репозитории; теги Git.