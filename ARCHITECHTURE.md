# Архитектура проекта

Документ описывает архитектуру прошивки устройства «Heater Sensor Modbus Slave» на базе STM32F401CCU6: уровни, подсистемы, данные и потоки выполнения.

Содержание:
- Контекст и цели
- Обзор архитектуры
- Подсистемы и модули
- Модель данных и регистровая карта
- Потоки выполнения и тайминг
- Обработка ошибок и диагностика
- Конфигурация и постоянная память
- Репозиторий и структура проекта
- Допущения (Assumptions) для уточнения

## Контекст и цели

Устройство измеряет параметры, связанные с нагревателем (например, температуру(ы), состояние, питание) и предоставляет доступ к данным и конфигурации по протоколу Modbus (RTU поверх UART/RS‑485 или CDC-ACM/USB-UART). Прошивка реализует ведомое устройство (slave) с фиксированной картой регистров и настройками.

Цели:
- Надежный сбор и усреднение показаний.
- Низкая латентность ответа на Modbus-запросы.
- Возможность конфигурирования (адрес, скорость, параметры измерения).
- Диагностика и самоконтроль.

## Обзор архитектуры

Слои:
- HAL/LL: STM32Cube HAL для инициализации и работы с периферией (ADC, UART, TIM, GPIO, WDG, USB).
- Middleware:
  - Modbus RTU (минимальный стек стейт-машины: парсер кадров, CRC-16, диспетчеризация PDU к регистрам).
  - USB Device (CDC) — при наличии, для логирования/сервисного доступа.
- Application:
  - Sensor Manager: чтение ADC/датчиков, фильтрация/усреднение, калибровка.
  - Registry: модель данных и маппинг на Modbus Input/Holding/Coils/Discrete Inputs.
  - Config: хранение конфигурации в FLASH, загрузка по старту, сброс к заводским.
  - Diagnostics: флаги ошибок, телеметрия, счетчики.

Связи:
- Modbus Slave вызывает Registry для чтения/записи логических регистров.
- Registry получает актуальные значения от Sensor Manager.
- Config используется при инициализации UART/Modbus и алгоритмов измерения.

## Подсистемы и модули

1) Инициализация (Core/Src/main.c, stm32f4xx_hal_msp.c, system_stm32f4xx.c):
- Настройка тактирования (HSI/HSE → SYSCLK 84 МГц).
- Инициализация таймеров (TIMx) для периодики измерений и таймингов Modbus (t3.5).
- Инициализация UART (USARTx) для Modbus RTU и, опционально, GPIO для DE/RE (RS‑485).
- Инициализация USB CDC (если используется).
- Запуск сторожевого таймера (IWDG, опционально).

2) Sensor Manager:
- Драйвер ADC1 (регулярный/инжектированный канал(ы)) для термодатчика/NTC.
- Возможная поддержка внешних датчиков (например, 1-Wire/DS18B20 — при наличии) через отдельный модуль.
- Фильтрация: экспоненциальное/бокс‑карт усреднение N выборок.
- Калибровка: смещение/масштаб (хранится в Holding).

3) Modbus RTU Slave:
- Прием UART ISR/DMA → RX буфер.
- Машина состояний: сбор кадра, контроль межкадрового интервала (t3.5), вычисление CRC-16 (Modbus).
- Парсинг PDU: поддержка FC 01/02/03/04/05/06/15/16, 43/14 (Basic Device ID — опционально).
- Обработка исключений (01, 02, 03, 04, 06, 08).
- Передача ответа через UART/DMA; управление DE/RE (RS‑485) при передаче.

4) Registry (модель данных):
- Карта регистров (Input, Holding, Coils, Discrete Inputs).
- Преобразование типов (Fixed‑Point Q16.16 или Q8.8) → 16-битные слова.
- Валидация на запись, транзакции мультизаписи, сохранение конфигурации по команде.

5) Config/FLASH:
- Структура конфигурации (адрес, скорость, паритет, период измерения, фильтрация, калибровки).
- Версионирование и контроль целостности (CRC32/магическое число).
- Механизм «commit» для сохранения (через coil/holding или спец. регистр).

6) Diagnostics/Logging:
- Счетчики ошибок CRC/протокола, таймауты, последняя ошибка.
- Температура MCU, напряжение питания (через ADC Vrefint, при необходимости).
- USB CDC лог (debug), отключаемый билд‑опциями.

## Модель данных и карта регистров

См. MODBUS-API.md для полного описания. Кратко:
- Input Registers (3xxxx): измеренные значения (температуры, питание, версия FW, статус).
- Holding Registers (4xxxx): конфигурация Modbus и измерений.
- Coils: команды/флаги (enable, save, reset).
- Discrete Inputs: статусные флаги неисправностей и состояний.

Форматы:
- Физические величины в фиксированной точке (например, температура в 0.01 °C).
- Версии — как major.minor.patch в одном/двух регистрах.

## Потоки выполнения и тайминг

- Main loop:
  - Сервис фоновых задач: обработка команд, логирование, контроль WDG.
- Прерывания:
  - UART RX/TX (DMA/ISR) — прием/передача Modbus.
  - TIMx — таймер измерений (например, 10–100 Гц) и таймер межкадровых пауз.
  - ADC EOC/ DMA — завершение преобразований.
- Тайминги Modbus RTU:
  - Межкадровый интервал t3.5 символа (зависит от бодрейта).
  - Обработка в пределах T_response_max (см. PRD).

## Обработка ошибок и диагностика

- Ошибки протокола: неправильный FC, адресация вне диапазона, CRC mismatch.
- Системные ошибки: перегрев, обрыв/КЗ датчика, out‑of‑range ADC, watchdog reset.
- Диагностика доступна в регистрах; необязательный вывод по USB CDC.

## Конфигурация и постоянная память

- Конфигурация хранится во FLASH:
  - Структура с версией, CRC, дефолтами.
  - Мягкое применение при записи Holding, долговременное — по команде «Save».
- Защита от износа: страничная запись/перестановка (wear‑leveling) — опционально.

## Репозиторий и структура проекта

Основано на STM32CubeMX/IDE структуре (наблюдаемые директории и файлы):
- Core/
- Drivers/
- Middlewares/
- USB_DEVICE/ (если включено CDC)
- startup/
- STM32F401CCUx_FLASH.ld
- h-id_heater_sensor_modbus_slave_stm32f401ccu6.ioc
- Проектные файлы (.project, .cproject, .mxproject)

Рекомендуемая организационная структура исходников (внутри Core/Src, Core/Inc):
- app/
  - sensor_manager.c/.h
  - registry.c/.h
  - config_store.c/.h
  - diagnostics.c/.h
- proto/
  - modbus_rtu.c/.h
  - modbus_crc.c/.h
- platform/
  - bsp_uart.c/.h (DE/RE)
  - bsp_adc.c/.h
  - bsp_timer.c/.h
  - bsp_flash.c/.h

## Допущения (для уточнения)

- Транспорт Modbus по умолчанию: RTU через USARTx + RS‑485; USB CDC — для сервиса/отладки.
- Используется HAL без RTOS.
- Датчик(и): NTC/термистор(ы) на ADC; альтернативно — внешний цифровой датчик (опция).
- DE/RE управляется GPIO, привязка к конкретному пину — см. .ioc.
- Параметры тактирования и частоты — дефолт STM32F401 (84 МГц).
- Конкретные номера UART/ADC каналов, пинмап — уточнить согласно .ioc.